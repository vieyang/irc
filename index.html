<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Irc</title>

    
    <script src = "https://cdn.wilddog.com/js/client/current/wilddog.js" ></script>
    
    <script>
      var ref = new Wilddog("https://irc.wilddogio.com/msgs/");
      var name = '';
      
</script>

    
    
  </head>
  <body>
       <input id="utx" style="width:45%;" type="text"   placeholder="请给自己起个好听的名字~~~"/>
       <input style="width:45%;" type="button"  onclick="initName()" value="设置"/>
       <br><br>
      <textarea style="width:100%; height: 300px" id="tx" disabled="disabled"></textarea>
        <br><br>
      <input type="button"  onclick="onUpdate()" value="发送"/>
      <br><br>
     <textarea style="width:100%; height: 300px" id="wtx"></textarea>

<script>
    var tx = document.getElementById("tx");
    var wtx = document.getElementById("wtx");
    var ntx = document.getElementById("utx");
    

    
    ref.on("child_added", function(snapshot,error) {
        var newPost = snapshot.val();
        if (newPost.userid == "") {
            tx.innerHTML +=  "*** " + newPost.msg + " ***\r\n";
        } else {
            tx.innerHTML += newPost.userid + ": " + newPost.msg + "\r\n";    
        }
        tx.scrollTop = tx.scrollHeight;
    });
   
    function onValue() {
        tx.innerHTML = "";
        ref.once("value", function(snapshot) {
            console.log("onValue");
            var vjson = snapshot.val();
            console.log(vjson);
            for(var v in vjson)  
            {
                tx.innerHTML += vjson[v].userid + ":" + vjson[v].msg+"\r\n";
            }
        });
    }

        
    function onUpdate() {
        if (name == "") {
            alert("给自己起个昵称~~~");
            return;
        }
        
        var v = wtx.value;
        if (v == "") {
            wtx.value = "";
            alert("输入点内容~~~");
            wtx.value = "";
            return;
        }
        
        
        ref.push({
            date: "123",
            msg: v,
            userid: name
        });
        
        wtx.value = "";
    }
    
    function initName() {
        if (name == ntx.value) return;
        var m = "";
        if (name == "") {
            m = "欢迎新用户[" + ntx.value + "]";
        } else {
            m = "我把昵称改成了[" + ntx.value + "]";
        }
        ref.push({
            date: "123",
            msg: m,
            userid: name
        });  
        name = ntx.value;
    }
    
    
    document.onkeydown=function(e){
    if(e.keyCode == 13 && e.ctrlKey){
                 // 这里实现换行
        wtx.value += "\r\n";
    }else if(e.keyCode == 13){
        // 避免回车键换行
        e.preventDefault();
        // 下面写你的发送消息的代码
        onUpdate();
    }
}
        
</script> 


  </body>
</html>
